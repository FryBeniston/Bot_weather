// bot.js â€” Ñ‚Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ Render / Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°

require('dotenv').config();
const { Telegraf } = require('telegraf');
const { handleTextMessage, handleLocation } = require('./src/bot/handlers');

const token = process.env.TELEGRAM_TOKEN;
if (!token) {
  console.error('âŒ TELEGRAM_TOKEN Ð½Ðµ Ð·Ð°Ð´Ð°Ð½ Ð² .env');
  process.exit(1);
}

const bot = new Telegraf(token);

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
bot.start((ctx) => {
  ctx.reply('ðŸŒ¤ ÐŸÑ€Ð¸Ð²ÐµÑ‚! ÐÐ°Ð¿Ð¸ÑˆÐ¸ Ð³Ð¾Ñ€Ð¾Ð´ Ð¸Ð»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒ Ð³ÐµÐ¾Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑŽ.', {
    reply_markup: {
      keyboard: [[{ text: "ðŸ“ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð³ÐµÐ¾Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑŽ", request_location: true }]],
      resize_keyboard: true,
      one_time_keyboard: true
    }
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', (ctx) => handleTextMessage(ctx));

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð³ÐµÐ¾Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸
bot.on('location', (ctx) => handleLocation(ctx));

// Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error(`âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐµ Telegram:`, err);
});

// Ð—Ð°Ð¿ÑƒÑÐº polling
bot.launch();

// ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));